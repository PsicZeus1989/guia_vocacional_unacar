<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Guía de Orientación Vocacional - UNACAR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #006699;
      --primary-soft: #e0f3fb;
      --bg: #f5f5f7;
      --card-bg: #ffffff;
      --text-main: #222222;
      --text-muted: #555555;
      --border-radius: 12px;
    }
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text-main);
    }
    .app-container {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 16px 64px;
    }
    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: 0 8px 24px rgba(0,0,0,0.06);
      padding: 24px 20px;
      margin-bottom: 24px;
    }
    h1, h2, h3 {
      margin-top: 0;
      color: #003b5c;
    }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 0.4rem;
    }
    h2 {
      font-size: 1.4rem;
      margin-bottom: 0.4rem;
    }
    .subtitle {
      color: var(--text-muted);
      margin-bottom: 1rem;
    }
    .step-indicator {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .step-pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: #dde2e7;
      font-size: 0.8rem;
      color: #444;
    }
    .step-pill.active {
      background: var(--primary);
      color: #fff;
      font-weight: 600;
    }
    .step {
      display: none;
    }
    .step.active {
      display: block;
    }
    .btn-row {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 24px;
      flex-wrap: wrap;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 10px 18px;
      font-size: 0.95rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    .btn-primary:hover {
      background: #00527a;
    }
    .btn-secondary {
      background: #e0e4ea;
      color: #222;
    }
    .btn-secondary:hover {
      background: #cdd3dc;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px 20px;
    }
    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 4px;
      font-weight: 500;
    }
    input[type="text"],
    input[type="email"],
    input[type="date"],
    input[type="number"],
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #c9ced6;
      font-size: 0.9rem;
    }
    input:focus,
    select:focus {
      outline: 2px solid var(--primary-soft);
      border-color: var(--primary);
    }
    .hint {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .alert {
      background: #fff7e0;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 0.85rem;
      border-left: 4px solid #f5b400;
      margin: 8px 0 12px;
    }
    .question-list {
      max-height: 70vh;
      overflow-y: auto;
      padding-right: 8px;
      margin-top: 8px;
      border-radius: 8px;
      border: 1px solid #dde2ea;
      background: #fafbfc;
    }
    .question-item {
      padding: 10px 12px;
      border-bottom: 1px solid #e4e7ee;
    }
    .question-item:last-child {
      border-bottom: none;
    }
    .question-title {
      font-size: 0.9rem;
      margin-bottom: 4px;
      font-weight: 500;
    }
    .options-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 20px;
      font-size: 0.88rem;
    }
    .options-row label {
      font-weight: 400;
      margin-bottom: 0;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .progress-bar {
      width: 100%;
      background: #e6ebf2;
      border-radius: 999px;
      overflow: hidden;
      height: 8px;
      margin-top: 6px;
      margin-bottom: 4px;
    }
    .progress-bar-inner {
      height: 100%;
      width: 0%;
      background: var(--primary);
      transition: width 0.25s ease;
    }
    .progress-text {
      font-size: 0.78rem;
      color: var(--text-muted);
      text-align: right;
    }
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
    }
    .result-card {
      border-radius: 10px;
      border: 1px solid #dde2ea;
      padding: 10px 12px;
      background: #fafbff;
    }
    .result-card h4 {
      margin: 0 0 4px;
      font-size: 0.98rem;
      color: #003b5c;
    }
    .result-card p {
      margin: 2px 0;
      font-size: 0.85rem;
      color: #444;
    }
    @media (max-width: 600px) {
      .card {
        padding: 18px 14px;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="card">
      <div class="step-indicator">
        <div class="step-pill step-pill-0 active">Bienvenida</div>
        <div class="step-pill step-pill-1">Datos generales</div>
        <div class="step-pill step-pill-2">Cuestionario de intereses</div>
        <div class="step-pill step-pill-3">Cuestionario de aptitudes</div>
        <div class="step-pill step-pill-4">Resultados</div>
      </div>

      <!-- Paso 0: Bienvenida -->
      <div class="step step-0 active">
        <h1>Guía de Orientación Vocacional UNACAR</h1>
        <p class="subtitle">
          Una herramienta para explorar qué carreras de la Universidad Autónoma del Carmen se ajustan mejor a tus intereses y aptitudes.
        </p>
        <p>
          Esta guía está pensada para estudiantes de nivel medio superior que están por elegir una carrera universitaria.
          A través de dos cuestionarios, se analizan tus intereses y tus aptitudes en diferentes áreas y se genera una
          sugerencia de programas educativos de la UNACAR que podrían ser compatibles contigo.
        </p>
        <div class="alert">
          <strong>Importante:</strong> Esta guía es un apoyo para la toma de decisiones, pero <strong>no sustituye</strong>
          un proceso formal de orientación vocacional ni una atención personalizada con un profesional.
        </div>
        <p>
          Al finalizar, verás un resumen con los factores en los que presentas mayor afinidad y una lista de carreras sugeridas
          con base en tus resultados.
        </p>
        <div class="btn-row">
          <button class="btn-primary" type="button" onclick="goToStep(1)">
            Comenzar
          </button>
        </div>
      </div>

      <!-- Paso 1: Datos generales -->
      <div class="step step-1">
        <h2>Datos generales</h2>
        <p class="subtitle">
          Por favor, completa tu información. Esto nos ayuda a identificar tus resultados y conocer mejor el
          contexto desde el que estás eligiendo tu carrera.
        </p>

        <form id="form-datos">
          <div class="form-grid">
            <div>
              <label for="nombre">Nombre completo*</label>
              <input type="text" id="nombre" name="nombre" required />
            </div>
            <div>
              <label for="edad">Edad*</label>
              <input type="number" id="edad" name="edad" min="14" required />
            </div>
            <div>
              <label for="fecha_nacimiento">Fecha de nacimiento*</label>
              <input type="date" id="fecha_nacimiento" name="fecha_nacimiento" required />
            </div>
            <div>
              <label for="ciudad">Ciudad*</label>
              <input type="text" id="ciudad" name="ciudad" required />
            </div>
            <div>
              <label for="estado">Estado*</label>
              <input type="text" id="estado" name="estado" required />
            </div>
            <div>
              <label for="preparatoria">Preparatoria / Bachillerato*</label>
              <input type="text" id="preparatoria" name="preparatoria" required />
            </div>
            <div>
              <label for="correo">Correo electrónico*</label>
              <input type="email" id="correo" name="correo" required />
              <div class="hint">Se utilizará solo para identificar tu reporte si la UNACAR decide implementarlo así.</div>
            </div>
            <div>
              <label for="opcion1">Primera opción de carrera en la UNACAR*</label>
              <select id="opcion1" name="opcion1" required>
                <option value="">Selecciona una opción</option>
              </select>
            </div>
            <div>
              <label for="opcion2">Segunda opción de carrera en la UNACAR*</label>
              <select id="opcion2" name="opcion2" required>
                <option value="">Selecciona una opción</option>
              </select>
              <div class="hint">Si aún no tienes segunda opción clara, elige la que más te llame la atención por ahora.</div>
            </div>
          </div>
        </form>

        <div class="btn-row">
          <button class="btn-secondary" type="button" onclick="goToStep(0)">Regresar</button>
          <button class="btn-primary" type="button" onclick="handleDatosNext()">Continuar</button>
        </div>
      </div>

      <!-- Paso 2: Cuestionario de intereses (Thurstone) -->
      <div class="step step-2">
        <h2>Cuestionario de intereses</h2>
        <p class="subtitle">
          Inventario de intereses: elige en qué ocupación preferirías trabajar.
        </p>
        <p>
          A continuación verás una serie de pares de ocupaciones u oficios. En cada reactivo, piensa en la pregunta:
          <strong>“¿En cuál de estas opciones preferiría trabajar?”</strong> y marca solo una alternativa por renglón.
        </p>
        <ul class="hint">
          <li>No hay respuestas “buenas” o “malas”.</li>
          <li>Responde con sinceridad, pensando en lo que realmente te gustaría, no solo en lo que crees que “deberías” elegir.</li>
          <li>Es importante contestar <strong>todos</strong> los reactivos.</li>
        </ul>

        <div>
          <div class="progress-bar">
            <div id="progress-intereses" class="progress-bar-inner"></div>
          </div>
          <div class="progress-text">
            <span id="progress-intereses-text">0 / 0 contestadas</span>
          </div>
        </div>

        <div id="contenedor-intereses" class="question-list">
          <!-- Aquí se inyectan las preguntas de Thurstone -->
        </div>

        <div class="btn-row">
          <button class="btn-secondary" type="button" onclick="goToStep(1)">Regresar</button>
          <button class="btn-primary" type="button" onclick="handleInteresesNext()">Continuar</button>
        </div>
      </div>

      <!-- Paso 3: Cuestionario de aptitudes -->
      <div class="step step-3">
        <h2>Cuestionario de aptitudes</h2>
        <p class="subtitle">
          ¿Qué tanto te consideras competente en distintas actividades?
        </p>
        <p>
          En este cuestionario se presentan diferentes actividades. Para cada una, marca la opción que mejor describa
          qué tan competente te consideras actualmente para realizarla.
        </p>
        <ul class="hint">
          <li><strong>1</strong> = Me considero <strong>incompetente</strong> para esa actividad.</li>
          <li><strong>2</strong> = Me considero <strong>medianamente apto(a)</strong>.</li>
          <li><strong>3</strong> = Me considero <strong>bastante apto(a)</strong>.</li>
          <li><strong>4</strong> = Me considero <strong>muy apto(a)</strong>.</li>
        </ul>
        <p class="hint">
          No pienses tanto en calificaciones escolares, sino en qué tan capaz te sientes tú al realizar cada actividad.
        </p>

        <div>
          <div class="progress-bar">
            <div id="progress-aptitudes" class="progress-bar-inner"></div>
          </div>
          <div class="progress-text">
            <span id="progress-aptitudes-text">0 / 0 contestadas</span>
          </div>
        </div>

        <div id="contenedor-aptitudes" class="question-list">
          <!-- Aquí se inyectan las preguntas de aptitudes -->
        </div>

        <div class="btn-row">
          <button class="btn-secondary" type="button" onclick="goToStep(2)">Regresar</button>
          <button class="btn-primary" type="button" onclick="handleAptitudesNext()">Ver resultados</button>
        </div>
      </div>

      <!-- Paso 4: Resultados -->
      <div class="step step-4">
        <h2>Resultados preliminares</h2>
        <p class="subtitle">
          Este resumen se basa en tus respuestas de intereses y aptitudes. Úsalo como guía, no como una decisión definitiva.
        </p>

        <div id="resumen-alumno" class="result-card" style="margin-bottom: 16px;">
          <!-- Se llena con los datos generales -->
        </div>

        <h3>Tus factores más altos</h3>
        <div id="contenedor-factores" class="results-grid">
          <!-- Tarjetas de factores -->
        </div>

        <h3>Carreras de la UNACAR sugeridas</h3>
        <div id="contenedor-carreras" class="results-grid">
          <!-- Tarjetas de carreras -->
        </div>

        <h3>Compatibilidad con tus opciones elegidas</h3>
        <div id="compat-elecciones" class="results-grid">
          <!-- Compatibilidad con opción 1 y opción 2 -->
        </div>

        <div class="alert">
          Recuerda que estos resultados son una guía. En caso de tener más dudas, busca orientación vocacional con un profesional.
        </div>

        <div class="btn-row">
          <button class="btn-secondary" type="button" onclick="goToStep(0)">Volver al inicio</button>
          <button class="btn-primary" type="button" onclick="generatePDF()">Descargar / guardar reporte en PDF</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Datos de cuestionarios -->
  <script src="datos_cuestionarios.js"></script>

  <!-- Lógica principal -->
  <script>
    const factorDefinitions = [
      { id: 1, key: "cientifico", label: "Científico", interestArea: "C. Biologicas", aptitudeSection: "F", divisor: 2,
        description: "Te interesan la investigación, la observación rigurosa y la comprensión de fenómenos naturales y científicos. Disfrutas analizar datos, hacer hipótesis y buscar explicaciones lógicas sobre cómo funciona el mundo." },
      { id: 2, key: "numerico", label: "Numérico", interestArea: "Calculo", aptitudeSection: "B", divisor: 2,
        description: "Te sientes cómodo trabajando con números, operaciones, porcentajes y problemas cuantitativos. Sueles disfrutar actividades donde hay que calcular, comparar cantidades o interpretar resultados numéricos." },
      { id: 3, key: "razonamiento_mecanico", label: "Razonamiento mecánico", interestArea: "C. Fisicas", aptitudeSection: "C", divisor: 2,
        description: "Te resulta interesante entender cómo funcionan máquinas, herramientas, estructuras o sistemas físicos. Te es natural imaginar mecanismos, movimientos, fuerzas y soluciones técnicas o estructurales." },
      { id: 4, key: "artistico", label: "Artístico", interestArea: "Artisticas", aptitudeSection: "D", divisor: 2,
        description: "Te atrae crear, diseñar o expresarte a través de formas, colores, imágenes o composiciones. Tiendes a buscar maneras originales de comunicar ideas y emociones, valorando la estética y la creatividad." },
      { id: 5, key: "musical", label: "Musical", interestArea: "Musicales", aptitudeSection: "E", divisor: 2,
        description: "Tienes sensibilidad para el ritmo, la melodía y el sonido. Te interesa escuchar, interpretar o incluso crear música, y sueles percibir matices sonoros que quizá otras personas pasan por alto." },
      { id: 6, key: "social", label: "Social", interestArea: "Humanitarias", aptitudeSection: "G", divisor: 2,
        description: "Te interesa trabajar con personas, comprender sus necesidades y acompañarlas. Disfrutas ayudar, orientar, enseñar o brindar apoyo, y valoras el contacto humano y el trabajo en equipo." },
      { id: 7, key: "destreza_manual", label: "Destreza manual", interestArea: null, aptitudeSection: "H", divisor: 1,
        description: "Tienes facilidad para usar tus manos con precisión: armar, reparar, manipular herramientas o materiales. Te sientes cómodo en actividades que requieren coordinación ojo–mano y cuidado en los detalles." },
      { id: 8, key: "practica", label: "Práctico", interestArea: null, aptitudeSection: "I", divisor: 1,
        description: "Prefieres actividades concretas y aplicadas, donde puedas ver resultados tangibles. Te gusta resolver problemas de forma directa, organizar tareas y pasar a la acción más que quedarte solo en lo teórico." },
      { id: 9, key: "ejecutivo_persuasivo", label: "Ejecutivo-persuasivo", interestArea: "Ejecutivas", aptitudeSection: "J", divisor: 2,
        description: "Te ves coordinando, liderando o tomando decisiones. Te gusta organizar personas y recursos, proponer proyectos y convencer a otros de tus ideas, con habilidad para hablar en público y negociar." },
      { id: 10, key: "verbal_literaria", label: "Verbal-literario", interestArea: "Literarias", aptitudeSection: "A", divisor: 2,
        description: "Disfrutas leer, escribir, explicar y usar el lenguaje para comunicar ideas. Te interesa redactar, argumentar y comprender textos, así como expresar pensamientos de forma clara y estructurada." },
      { id: 11, key: "trabajo_oficina", label: "Trabajo de oficina", interestArea: null, aptitudeSection: "K", divisor: 1,
        description: "Te sientes cómodo en tareas administrativas: registrar información, organizar documentos, manejar agendas o sistemas de archivo. Valorás el orden, la precisión y los procedimientos claros." },
      { id: 12, key: "negocios", label: "Negocios", interestArea: "Negocios", aptitudeSection: null, divisor: 1,
        description: "Te interesan las actividades relacionadas con empresas, ventas, emprendimiento y gestión económica. Te llama la atención identificar oportunidades, planear proyectos y tomar decisiones orientadas a resultados." }
    ];

    const programFactors = [
      { name: "Lic. En Derecho", factors: [1, 6, 10, 11] },
      { name: "Lic. En Criminologia y Criminalistica", factors: [1, 2, 6, 9, 10, 11] },
      { name: "Lic en Administracion de Empresas", factors: [2, 6, 9, 10, 11] },
      { name: "Lic. En Contaduria", factors: [2, 6, 9, 10, 11] },
      { name: "Lic. En Administracion Turistica", factors: [2, 6, 8, 9, 10, 11] },
      { name: "Lic. En Mercadotecnia", factors: [2, 4, 6, 9, 10, 11] },
      { name: "Lic. En Negocios Internacionales", factors: [1, 2, 6, 9, 10, 11] },
      { name: "Lic. En Educacion", factors: [1, 6, 9, 11] },
      { name: "Lic. En Lengua Inglesa", factors: [1, 6, 10, 11] },
      { name: "Lic. En Educacion y Gestion Cultural", factors: [1, 4, 6, 9, 10, 11] },
      { name: "Lic. En Ingenieria Quimica", factors: [1, 2, 3, 9, 11] },
      { name: "Lic. En Ingenieria Petrolera", factors: [1, 2, 3, 8] },
      { name: "Lic. En Geologia", factors: [1, 2, 3, 7, 8] },
      { name: "Lic. En Ingenieria en Sistemas Computacionales", factors: [1, 2, 3, 8, 9, 11] },
      { name: "Lic. En Ingenieria en Diseño Multimedia", factors: [1, 2, 3, 4, 8, 11] },
      { name: "Lic. En Ingenieria en Tecnologias de Computo y Comunicaciones", factors: [1, 2, 3, 8, 9, 11] },
      { name: "Lic. En Ingenieria Mecatronica", factors: [1, 2, 3, 7, 8, 9] },
      { name: "Lic. En Ingenieria Civil", factors: [1, 2, 3, 8, 9] },
      { name: "Lic. En Ingenieria Mecanica", factors: [1, 2, 3, 8, 9] },
      { name: "Lic. En Ingenieria Geofisica", factors: [1, 2, 3, 7, 8] },
      { name: "Lic. En Ingenieria en Energia", factors: [1, 2, 3, 9] },
      { name: "Lic. En Arquitectura Sustentable", factors: [1, 2, 3, 4, 8, 11] },
      { name: "Lic. En Educacion Fisica y Deportes", factors: [1, 3, 6, 7, 8, 9] },
      { name: "Lic. En Enfermeria", factors: [1, 3, 6, 9, 11] },
      { name: "Lic. En Nutricion", factors: [1, 3, 6, 9, 10, 11] },
      { name: "Lic. En Psicologia", factors: [1, 3, 6, 9, 10, 11] },
      { name: "Lic. En Fisioterapia", factors: [1, 3, 6, 7, 8, 9, 11] },
      { name: "Lic. En Medicina", factors: [1, 2, 3, 6, 8, 9, 11] },
      { name: "Lic. En Biologia Marina", factors: [1, 2, 3, 4, 11] }
    ];

    const thurstoneAreas = [
      "Artisticas",
      "C. Biologicas",
      "C. Fisicas",
      "Calculo",
      "Ejecutivas",
      "Humanitarias",
      "Literarias",
      "Musicales",
      "Negocios",
      "Persuasivas"
    ];

    const aptitudeSections = [
      { code: "A", name: "Verbal" },
      { code: "B", name: "Numérica" },
      { code: "C", name: "Mecánica constructivista" },
      { code: "D", name: "Artística" },
      { code: "E", name: "Musical" },
      { code: "F", name: "Científica" },
      { code: "G", name: "Social" },
      { code: "H", name: "Destreza manual" },
      { code: "I", name: "Práctica" },
      { code: "J", name: "Ejecutiva" },
      { code: "K", name: "Oficina" }
    ];

    function scoreThurstone(responses) {
      const scores = {};
      thurstoneAreas.forEach(area => { scores[area] = 0; });

      thurstoneItems.forEach(item => {
        const chosenKey = responses[String(item.id)];
        if (!chosenKey) return;
        const option = item.options.find(o => o.key === chosenKey);
        if (!option) return;
        scores[option.area] += option.score;
      });
      return scores;
    }

    function scoreAptitudes(responses) {
      const scores = {};
      aptitudeSections.forEach(sec => { scores[sec.code] = 0; });

      aptitudeItems.forEach(item => {
        const raw = responses[item.id];
        if (raw == null) return;
        const value = Number(raw);
        if (Number.isNaN(value)) return;
        scores[item.section] += value;
      });
      return scores;
    }

    function computeFactors(thurstoneScores, aptitudeScores) {
      const factorScores = {};
      factorDefinitions.forEach(f => {
        const interest = f.interestArea ? (thurstoneScores[f.interestArea] || 0) : 0;
        const aptitude = f.aptitudeSection ? (aptitudeScores[f.aptitudeSection] || 0) : 0;
        const raw = interest + aptitude;
        const value = raw / f.divisor;

        factorScores[f.id] = {
          id: f.id,
          label: f.label,
          value,
          interest,
          aptitude,
          description: f.description
        };
      });
      return factorScores;
    }

    function scoreCareerForStudent(career, factorScores) {
      const values = career.factors.map(id => (factorScores[id]?.value || 0));
      if (values.length === 0) return 0;
      const sum = values.reduce((a, b) => a + b, 0);
      return sum / values.length;
    }

    function getTopFactors(factorScores, topN = 5) {
      return Object.values(factorScores)
        .sort((a, b) => b.value - a.value)
        .slice(0, topN);
    }

    function getTopCareers(factorScores, topN = 3) {
      const scored = programFactors.map(p => ({
        program: p,
        score: scoreCareerForStudent(p, factorScores)
      })).sort((a, b) => b.score - a.score);
      return scored.slice(0, topN);
    }

    function findProgramByName(name) {
      if (!name) return null;
      return programFactors.find(p => p.name === name) || null;
    }

    let currentStep = 0;
    const datosAlumno = {};
    const respuestasIntereses = {};
    const respuestasAptitudes = {};

    const cachedResultados = {
      intereses: null,
      aptitudes: null,
      factores: null,
      topFactores: null,
      topCarreras: null
    };

    function goToStep(step) {
      currentStep = step;
      document.querySelectorAll(".step").forEach((el, idx) => {
        el.classList.toggle("active", idx === step);
      });
      document.querySelectorAll(".step-pill").forEach((el, idx) => {
        el.classList.toggle("active", idx === step);
      });
    }

    function handleDatosNext() {
      const form = document.getElementById("form-datos");
      if (!form.reportValidity()) return;

      const fd = new FormData(form);
      fd.forEach((value, key) => {
        datosAlumno[key] = value.toString().trim();
      });

      if (datosAlumno["opcion1"] && datosAlumno["opcion1"] === datosAlumno["opcion2"]) {
        alert("Tu primera y segunda opción de carrera no deben ser la misma. Elige una diferente.");
        return;
      }

      goToStep(2);
    }

    function handleInteresesNext() {
      const total = thurstoneItems.length;
      let contestadas = 0;
      thurstoneItems.forEach(item => {
        const sel = document.querySelector(`input[name="thurstone-${item.id}"]:checked`);
        if (sel) contestadas++;
      });
      if (contestadas < total) {
        if (!confirm(`Aún te faltan ${total - contestadas} reactivos por contestar. ¿Seguro que quieres continuar?`)) {
          return;
        }
      }

      thurstoneItems.forEach(item => {
        const sel = document.querySelector(`input[name="thurstone-${item.id}"]:checked`);
        if (sel) {
          respuestasIntereses[item.id] = sel.value;
        }
      });

      goToStep(3);
    }

    function handleAptitudesNext() {
      const total = aptitudeItems.length;
      let contestadas = 0;
      aptitudeItems.forEach(item => {
        const sel = document.querySelector(`input[name="apt-${item.id}"]:checked`);
        if (sel) contestadas++;
      });
      if (contestadas < total) {
        if (!confirm(`Aún te faltan ${total - contestadas} reactivos por contestar. ¿Seguro que quieres continuar?`)) {
          return;
        }
      }

      aptitudeItems.forEach(item => {
        const sel = document.querySelector(`input[name="apt-${item.id}"]:checked`);
        if (sel) {
          respuestasAptitudes[item.id] = sel.value;
        }
      });

      calcularYMostrarResultados();
      goToStep(4);
    }

    function actualizarProgresoIntereses() {
      const total = thurstoneItems.length;
      let contestadas = 0;
      thurstoneItems.forEach(item => {
        const sel = document.querySelector(`input[name="thurstone-${item.id}"]:checked`);
        if (sel) contestadas++;
      });
      const pct = total ? (contestadas / total) * 100 : 0;
      document.getElementById("progress-intereses").style.width = pct + "%";
      document.getElementById("progress-intereses-text").textContent =
        `${contestadas} / ${total} contestadas`;
    }

    function actualizarProgresoAptitudes() {
      const total = aptitudeItems.length;
      let contestadas = 0;
      aptitudeItems.forEach(item => {
        const sel = document.querySelector(`input[name="apt-${item.id}"]:checked`);
        if (sel) contestadas++;
      });
      const pct = total ? (contestadas / total) * 100 : 0;
      document.getElementById("progress-aptitudes").style.width = pct + "%";
      document.getElementById("progress-aptitudes-text").textContent =
        `${contestadas} / ${total} contestadas`;
    }

    function calcularYMostrarResultados() {
      const intereses = scoreThurstone(respuestasIntereses);
      const aptitudes = scoreAptitudes(respuestasAptitudes);
      const factores = computeFactors(intereses, aptitudes);
      const topFactores = getTopFactors(factores, 5);
      const topCarreras = getTopCareers(factores, 3);

      cachedResultados.intereses = intereses;
      cachedResultados.aptitudes = aptitudes;
      cachedResultados.factores = factores;
      cachedResultados.topFactores = topFactores;
      cachedResultados.topCarreras = topCarreras;

      const ra = document.getElementById("resumen-alumno");
      ra.innerHTML = `
        <h4>Datos del alumno</h4>
        <p><strong>Nombre:</strong> ${datosAlumno.nombre || "-"} </p>
        <p><strong>Edad:</strong> ${datosAlumno.edad || "-"} &nbsp; &bull; &nbsp;
           <strong>Fecha de nacimiento:</strong> ${datosAlumno.fecha_nacimiento || "-"}</p>
        <p><strong>Ciudad y estado:</strong> ${datosAlumno.ciudad || "-"}, ${datosAlumno.estado || "-"}</p>
        <p><strong>Preparatoria:</strong> ${datosAlumno.preparatoria || "-"} </p>
        <p><strong>Correo:</strong> ${datosAlumno.correo || "-"} </p>
        <p><strong>Primera opción UNACAR:</strong> ${datosAlumno.opcion1 || "-"}<br/>
           <strong>Segunda opción UNACAR:</strong> ${datosAlumno.opcion2 || "-"}
        </p>
      `;

      const cf = document.getElementById("contenedor-factores");
      cf.innerHTML = "";
      topFactores.forEach(f => {
        const div = document.createElement("div");
        div.className = "result-card";
        div.innerHTML = `
          <h4>${f.id}. ${f.label}</h4>
          <p><strong>Puntaje promedio del factor:</strong> ${f.value.toFixed(2)}</p>
          <p>${f.description || ""}</p>
        `;
        cf.appendChild(div);
      });

      const cc = document.getElementById("contenedor-carreras");
      cc.innerHTML = "";
      topCarreras.forEach((c, idx) => {
        const div = document.createElement("div");
        div.className = "result-card";
        div.innerHTML = `
          <h4>${idx + 1}. ${c.program.name}</h4>
          <p><strong>Compatibilidad relativa:</strong> ${c.score.toFixed(2)}</p>
          <p style="font-size:0.8rem; color:#555;">
            Factores considerados: ${c.program.factors.join(", ")}
          </p>
        `;
        cc.appendChild(div);
      });

      const compatDiv = document.getElementById("compat-elecciones");
      compatDiv.innerHTML = "";
      ["opcion1", "opcion2"].forEach((key, idx) => {
        const nombre = datosAlumno[key];
        if (!nombre) return;
        const prog = findProgramByName(nombre);
        const div = document.createElement("div");
        div.className = "result-card";

        if (!prog) {
          div.innerHTML = `
            <h4>${idx === 0 ? "Primera" : "Segunda"} opción: ${nombre}</h4>
            <p>No se encontró esta carrera en el catálogo de programas de la guía.</p>
          `;
        } else {
          const score = scoreCareerForStudent(prog, factores);
          div.innerHTML = `
            <h4>${idx === 0 ? "Primera" : "Segunda"} opción: ${prog.name}</h4>
            <p><strong>Compatibilidad relativa con tus factores:</strong> ${score.toFixed(2)}</p>
            <p style="font-size:0.8rem; color:#555;">
              Factores asociados a esta carrera: ${prog.factors.join(", ")}
            </p>
          `;
        }
        compatDiv.appendChild(div);
      });
    }

    function poblarSelectCarreras() {
      const select1 = document.getElementById("opcion1");
      const select2 = document.getElementById("opcion2");
      const nombres = Array.from(new Set(programFactors.map(p => p.name))).sort();

      nombres.forEach(nombre => {
        const opt1 = document.createElement("option");
        opt1.value = nombre;
        opt1.textContent = nombre;
        select1.appendChild(opt1);

        const opt2 = document.createElement("option");
        opt2.value = nombre;
        opt2.textContent = nombre;
        select2.appendChild(opt2);
      });
    }

    function renderIntereses() {
      const cont = document.getElementById("contenedor-intereses");
      cont.innerHTML = "";

      thurstoneItems.forEach(item => {
        const div = document.createElement("div");
        div.className = "question-item";

        const textoBase = `Reactivo ${item.id}. ¿En cuál de las siguientes ocupaciones preferirías trabajar?`;
        const optA = item.options.find(o => o.key === "a");
        const optB = item.options.find(o => o.key === "b");

        div.innerHTML = `
          <div class="question-title">${textoBase}</div>
          <div class="options-row">
            <label>
              <input type="radio" name="thurstone-${item.id}" value="a" />
              a) ${optA ? optA.text : "Opción A"}
            </label>
            <label>
              <input type="radio" name="thurstone-${item.id}" value="b" />
              b) ${optB ? optB.text : "Opción B"}
            </label>
          </div>
        `;
        cont.appendChild(div);
      });

      actualizarProgresoIntereses();

      cont.addEventListener("change", (ev) => {
        if (ev.target && ev.target.name && ev.target.name.startsWith("thurstone-")) {
          actualizarProgresoIntereses();
        }
      });
    }

    function renderAptitudes() {
      const cont = document.getElementById("contenedor-aptitudes");
      cont.innerHTML = "";

      aptitudeItems.forEach((item, idx) => {
        const div = document.createElement("div");
        div.className = "question-item";

        const textoBase = `${idx + 1}. ${item.text}`;

        div.innerHTML = `
          <div class="question-title">${textoBase}</div>
          <div class="options-row">
            <label>
              <input type="radio" name="apt-${item.id}" value="1" />
              1) Me considero incompetente
            </label>
            <label>
              <input type="radio" name="apt-${item.id}" value="2" />
              2) Medianamente apto(a)
            </label>
            <label>
              <input type="radio" name="apt-${item.id}" value="3" />
              3) Bastante apto(a)
            </label>
            <label>
              <input type="radio" name="apt-${item.id}" value="4" />
              4) Muy apto(a)
            </label>
          </div>
        `;
        cont.appendChild(div);
      });

      actualizarProgresoAptitudes();

      cont.addEventListener("change", (ev) => {
        if (ev.target && ev.target.name && ev.target.name.startsWith("apt-")) {
          actualizarProgresoAptitudes();
        }
      });
    }

    // Versión sin librería externa: abre una vista imprimible y
    // el usuario puede elegir "Guardar como PDF" en el diálogo de impresión.
    function generatePDF() {
      if (!cachedResultados.factores || !cachedResultados.topFactores || !cachedResultados.topCarreras) {
        alert("Primero completa los cuestionarios y visualiza tus resultados.");
        return;
      }

      const factores = cachedResultados.factores;
      const topFactores = cachedResultados.topFactores;
      const topCarreras = cachedResultados.topCarreras;

      const win = window.open("", "_blank");
      if (!win) {
        alert("El navegador bloqueó la ventana emergente. Permite las ventanas emergentes para esta página para poder generar el PDF.");
        return;
      }

      let html = "";
      html += "<!DOCTYPE html><html lang='es'><head><meta charset='UTF-8'>";
      html += "<title>Reporte de orientación vocacional UNACAR</title>";
      html += "<style>";
      html += "body { font-family: Arial, sans-serif; font-size: 12px; margin: 24px; }";
      html += "h1 { font-size: 18px; margin-bottom: 4px; }";
      html += "h2 { font-size: 15px; margin-top: 16px; margin-bottom: 6px; }";
      html += "p { margin: 2px 0; }";
      html += "ul { margin: 4px 0 8px 18px; padding: 0; }";
      html += "li { margin-bottom: 2px; }";
      html += ".small { font-size: 10px; color: #555; margin-top: 10px; }";
      html += "</style></head><body>";

      html += "<h1>Guía de Orientación Vocacional UNACAR</h1>";
      html += "<p><strong>Reporte individual</strong></p>";

      html += "<h2>Datos del alumno</h2>";
      html += `<p><strong>Nombre:</strong> ${datosAlumno.nombre || "-"} </p>`;
      html += `<p><strong>Edad:</strong> ${datosAlumno.edad || "-"} &nbsp;&nbsp; <strong>Fecha de nacimiento:</strong> ${datosAlumno.fecha_nacimiento || "-"} </p>`;
      html += `<p><strong>Ciudad y estado:</strong> ${datosAlumno.ciudad || "-"}, ${datosAlumno.estado || "-"} </p>`;
      html += `<p><strong>Preparatoria / Bachillerato:</strong> ${datosAlumno.preparatoria || "-"} </p>`;
      html += `<p><strong>Correo electrónico:</strong> ${datosAlumno.correo || "-"} </p>`;
      html += `<p><strong>Primera opción UNACAR:</strong> ${datosAlumno.opcion1 || "-"} </p>`;
      html += `<p><strong>Segunda opción UNACAR:</strong> ${datosAlumno.opcion2 || "-"} </p>`;

      html += "<h2>Factores más altos</h2>";
      html += "<ul>";
      topFactores.forEach(f => {
        html += `<li><strong>${f.id}. ${f.label}</strong> – Puntaje promedio: ${f.value.toFixed(2)}<br/>${f.description || ""}</li>`;
      });
      html += "</ul>";

      html += "<h2>Carreras sugeridas por la guía</h2>";
      html += "<ul>";
      topCarreras.forEach((c, idx) => {
        html += `<li>${idx + 1}. ${c.program.name} – compatibilidad relativa: ${c.score.toFixed(2)}</li>`;
      });
      html += "</ul>";

      html += "<h2>Compatibilidad con tus opciones elegidas</h2>";
      html += "<ul>";
      ["opcion1", "opcion2"].forEach((key, idx) => {
        const nombre = datosAlumno[key];
        const etiqueta = idx === 0 ? "Primera opción" : "Segunda opción";
        if (!nombre) return;
        const prog = findProgramByName(nombre);
        if (!prog) {
          html += `<li>${etiqueta}: ${nombre} (no se encontró esta carrera en el catálogo de la guía)</li>`;
        } else {
          const score = scoreCareerForStudent(prog, factores);
          html += `<li>${etiqueta}: ${prog.name} – compatibilidad relativa: ${score.toFixed(2)} (factores: ${prog.factors.join(", ")})</li>`;
        }
      });
      html += "</ul>";

      html += "<p class='small'>Nota: Este reporte es un apoyo orientativo y no sustituye un proceso formal de orientación vocacional con un profesional. En caso de tener más dudas, busca orientación vocacional con un profesional de tu confianza.</p>";
      html += "</body></html>";

      win.document.open();
      win.document.write(html);
      win.document.close();
      win.focus();

      // Lanza el diálogo de impresión para que el usuario pueda elegir "Guardar como PDF".
      win.print();
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (typeof thurstoneItems === "undefined" || !Array.isArray(thurstoneItems) || thurstoneItems.length === 0) {
        console.warn("thurstoneItems no está definido o está vacío.");
      }
      if (typeof aptitudeItems === "undefined" || !Array.isArray(aptitudeItems) || aptitudeItems.length === 0) {
        console.warn("aptitudeItems no está definido o está vacío.");
      }

      poblarSelectCarreras();
      if (typeof thurstoneItems !== "undefined" && thurstoneItems.length > 0) {
        renderIntereses();
      }
      if (typeof aptitudeItems !== "undefined" && aptitudeItems.length > 0) {
        renderAptitudes();
      }
    });
  </script>
</body>
</html>
